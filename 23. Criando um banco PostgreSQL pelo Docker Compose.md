
# Criando um banco PostgreSQL com Docker Compose (guia completo e simples)

Este material mostra **como criar e usar um banco PostgreSQL usando Docker Compose**, de forma **didática**, **passo a passo** e **próxima da realidade de projetos profissionais**.

A ideia é que você entenda:
- como subir um PostgreSQL em container
- como persistir dados corretamente
- como configurar usuários e banco
- como conectar outras aplicações depois
- quais erros evitar

---

## 1) Por que usar PostgreSQL com Docker Compose

Usar PostgreSQL via Docker Compose permite:
- não instalar banco localmente
- ter ambiente reproduzível
- subir banco com um comando
- isolar o banco da máquina host
- usar o mesmo setup em dev, staging e prod

Esse é o padrão moderno.

---

## 2) Arquitetura básica

Neste guia, teremos apenas:

```

Aplicação (futura) ───▶ PostgreSQL (container)

```

Por enquanto, vamos focar **só no banco**.

---

## 3) Estrutura mínima do projeto

Crie uma pasta com os seguintes arquivos:

```

postgres-compose/
├── docker-compose.yml
├── .env
└── README.md

````

---

## 4) Variáveis de ambiente (.env)

Crie o arquivo `.env`:

```env
POSTGRES_DB=app
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
````

O que cada variável significa:

* `POSTGRES_DB`: nome do banco que será criado automaticamente
* `POSTGRES_USER`: usuário administrador
* `POSTGRES_PASSWORD`: senha do usuário

Importante:

* não commitar `.env` em repositórios públicos
* usar valores diferentes em produção

---

## 5) Docker Compose do PostgreSQL

Crie o arquivo `docker-compose.yml`:

```yaml
services:
  db:
    image: postgres:16
    container_name: postgres-db
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  pgdata:
```

---

## 6) Entendendo cada parte do Compose

### `image: postgres:16`

* usa a imagem oficial do PostgreSQL
* versão fixa (boa prática)

---

### `container_name`

* nome explícito do container
* útil para debug local
* evite usar em ambientes com escala

---

### `restart: unless-stopped`

* banco reinicia automaticamente se cair
* volta após reboot do host
* não reinicia se você parar manualmente

---

### `env_file`

* carrega variáveis do `.env`
* mantém segredos fora do YAML

---

### `volumes`

```yaml
- pgdata:/var/lib/postgresql/data
```

* garante persistência dos dados
* sem volume, dados seriam perdidos

---

### `healthcheck`

* verifica se o banco está pronto
* usado por aplicações dependentes
* melhora estabilidade do sistema

---

## 7) Subindo o banco

Na raiz do projeto, execute:

```bash
docker compose up -d
```

Verifique se está rodando:

```bash
docker ps
```

Status esperado:

```
healthy
```

---

## 8) Testando o banco via terminal

### Entrando no container

```bash
docker exec -it postgres-db psql -U postgres -d app
```

Você deve ver o prompt:

```
app=#
```

---

### Teste simples SQL

```sql
SELECT version();
```

Ou:

```sql
CREATE TABLE teste (
  id SERIAL PRIMARY KEY,
  nome TEXT
);

INSERT INTO teste (nome) VALUES ('Docker funciona');
SELECT * FROM teste;
```

---

## 9) Persistência de dados (teste importante)

1. Crie dados no banco
2. Pare os containers:

```bash
docker compose down
```

3. Suba novamente:

```bash
docker compose up -d
```

4. Entre no banco e consulte os dados

Resultado esperado:

* os dados continuam lá

Isso confirma que o volume está funcionando.

---

## 10) Expondo ou não a porta do banco

### Não expor (recomendado)

```yaml
db:
  image: postgres:16
```

* ideal quando o banco só é usado por containers
* mais seguro

---

### Expor a porta (opcional em dev)

```yaml
ports:
  - "5432:5432"
```

Permite:

* acessar via DBeaver
* acessar via psql local
* debug em desenvolvimento

Nunca exponha em produção sem necessidade.

---

## 11) String de conexão PostgreSQL

Formato padrão:

```txt
postgresql://usuario:senha@host:porta/banco
```

No Docker Compose:

```txt
postgresql://postgres:postgres@db:5432/app
```

Onde:

* `db` é o nome do serviço
* nunca use `localhost` entre containers

---

## 12) Conectando uma aplicação depois

Exemplo (Python):

```python
import psycopg2
conn = psycopg2.connect(
    "postgresql://postgres:postgres@db:5432/app"
)
```

O banco estará acessível automaticamente pela rede Docker.

---

## 13) Erros comuns

* esquecer volume (dados perdidos)
* usar `localhost` no host do banco
* não usar healthcheck
* usar `latest`
* expor banco em produção
* subir banco sem senha

---

## 14) Boas práticas

* sempre usar volume
* fixar versão da imagem
* usar `.env`
* healthcheck ativo
* não expor banco sem motivo
* backups periódicos

---

## 15) Checklist rápido

* [ ] Imagem oficial do PostgreSQL
* [ ] Volume configurado
* [ ] Variáveis via `.env`
* [ ] Healthcheck ativo
* [ ] Restart policy definida
* [ ] Porta exposta apenas se necessário

---

## 16) Conclusão

Criar PostgreSQL com Docker Compose:

* é simples
* é profissional
* é reproduzível
* elimina problemas de ambiente

Esse setup é a **base** para:

* APIs
* sistemas web
* microserviços
* projetos full stack

---

## 17) Próximos passos possíveis

* PostgreSQL + Flask
* PostgreSQL + Node.js
* Migrations com Alembic
* Backup e restore de volumes
* PostgreSQL em produção (cloud)
* Docker Compose com múltiplos bancos

