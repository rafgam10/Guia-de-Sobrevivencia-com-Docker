
# Expondo portas e entendendo a flag `-p` no Docker

Expor portas é o que permite que **serviços rodando dentro de containers sejam acessados de fora**, seja pelo navegador, outra aplicação ou ferramentas como `curl` e Postman.

Esse é um conceito simples na superfície, mas que causa muita confusão no começo.

---

## 1) O problema: containers são isolados

Por padrão:
- containers rodam em uma rede interna do Docker
- serviços dentro do container **não são acessíveis externamente**
- mesmo que a aplicação esteja rodando, o host não “enxerga” a porta

Exemplo:
- Flask roda na porta `5000` dentro do container
- sem configuração extra, `localhost:5000` **não funciona**

---

## 2) O que significa expor uma porta

Expor uma porta significa:
- mapear uma porta do **host** (seu computador/servidor)
- para uma porta do **container**

Isso cria um “túnel” entre:
```

host:porta → container:porta

````

---

## 3) A flag `-p` (port mapping)

A flag `-p` é usada no `docker run` para fazer esse mapeamento.

### Sintaxe
```bash
docker run -p porta_host:porta_container imagem
````

Exemplo:

```bash
docker run -p 5000:5000 flask_app
```

Significa:

- porta `5000` do host
- redirecionada para a porta `5000` do container

Agora você acessa:

```
http://localhost:5000
```

---

## 4) Porta do container vs porta do host

É essencial entender que **essas portas não precisam ser iguais**.

Exemplo:

```bash
docker run -p 8080:5000 flask_app
```

- Flask roda na porta `5000` dentro do container
- Você acessa pela porta `8080` no host

Acesso:

```
http://localhost:8080
```

Isso é muito comum quando:

- a porta padrão já está em uso
- você roda vários containers do mesmo tipo

---

## 5) O erro mais comum: usar localhost entre containers

Dentro de um container:

- `localhost` aponta para **ele mesmo**
- nunca para outro container

Errado:

```txt
DATABASE_URL=postgres://user:pass@localhost:5432/db
```

Correto (Docker Compose):

```txt
DATABASE_URL=postgres://user:pass@db:5432/db
```

`-p` **não é usado para comunicação entre containers**, apenas para acesso externo.

---

## 6) `EXPOSE` vs `-p`

Esses dois conceitos são frequentemente confundidos.

### `EXPOSE` (Dockerfile)

```dockerfile
EXPOSE 5000
```

- apenas documenta que o container usa a porta `5000`
- não publica a porta
- não cria acesso externo

---

### `-p` (docker run)

```bash
docker run -p 5000:5000 flask_app
```

- publica a porta
- permite acesso externo
- cria o mapeamento host → container

Resumo:

- `EXPOSE` informa
- `-p` conecta

---

## 7) Expondo portas no Docker Compose

No Docker Compose, o equivalente ao `-p` é a diretiva `ports`.

### Exemplo

```yaml
services:
  api:
    image: flask_app
    ports:
      - "5000:5000"
```

Formato:

```yaml
"porta_host:porta_container"
```

O comportamento é o mesmo do `docker run -p`.

---

## 8) Quando NÃO expor portas

Nem todo serviço deve ser acessível externamente.

Exemplo clássico: banco de dados.

Errado (em produção):

```yaml
db:
  image: postgres:16
  ports:
    - "5432:5432"
```

Correto:

```yaml
db:
  image: postgres:16
```

- API acessa o banco pela rede interna
- banco não fica exposto ao host ou internet

---

## 9) Expor apenas para localhost

É possível limitar o bind ao `localhost`:

```bash
docker run -p 127.0.0.1:5000:5000 flask_app
```

Isso significa:

- acessível apenas localmente
- não exposto na rede

Boa prática em desenvolvimento.

---

## 10) Publicando portas automaticamente

Você pode deixar o Docker escolher a porta do host:

```bash
docker run -p 5000 flask_app
```

Docker escolhe uma porta aleatória no host.

Para descobrir:

```bash
docker ps
```

Uso comum:

- testes
- CI/CD
- ambientes temporários

---

## 11) Exemplo completo: Flask

### Flask rodando dentro do container

```python
app.run(host="0.0.0.0", port=5000)
```

Ponto crítico:

- `host="0.0.0.0"` é obrigatório
- `127.0.0.1` não funciona em container

### Rodando o container

```bash
docker run -p 5000:5000 flask_app
```

Acesso:

```
http://localhost:5000
```

---

## 12) Erros comuns

- Expor porta mas esquecer `0.0.0.0`
- Usar `EXPOSE` achando que publica porta
- Expor banco de dados desnecessariamente
- Usar `localhost` entre containers
- Confundir porta do host com a do container

---

## 13) Boas práticas

- Exponha apenas o que precisa ser acessado externamente
- Nunca exponha banco em produção
- Use portas diferentes no host se necessário
- Documente portas no Dockerfile (`EXPOSE`)
- Use Compose para projetos multi-container

---

## 14) Checklist rápido

-  Aplicação escuta em `0.0.0.0`
-  Porta do container está correta
-  Porta do host não está em uso
-  Serviço precisa mesmo ser exposto?
-  Comunicação interna usa nome do serviço

---

## 15) Conclusão

A flag `-p`:

- conecta o mundo externo ao container
- não influencia comunicação interna
- é essencial para acessar APIs, frontends e serviços web

Entender portas no Docker elimina uma grande parte das dores iniciais e evita erros clássicos em projetos reais.

---

## 16) Próximos tópicos sugeridos

- Docker Compose avançado
- Redes e portas em produção
- Reverse proxy com Nginx
- Deploy com Docker em cloud
- Segurança de containers